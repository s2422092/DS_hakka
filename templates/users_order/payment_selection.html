<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お支払い方法の選択 - モバおる</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/users_order.css') }}">
    <style>
        /* ここにPayPayモーダル用のCSSスタイルを追加 */
        /* cake_shop/index.html からコピーしたスタイルをベースに、調整 */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* 中央寄せ用 */
            justify-content: center; /* 中央寄せ用 */
            align-items: center; /* 中央寄せ用 */
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 10px;
            position: relative;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #payment-status-message {
            margin-top: 15px;
            font-weight: bold;
            color: #3498db;
        }
        .status-completed {
            color: #27ae60;
        }
        .status-failed {
            color: #e74c3c;
        }
        .status-timeout {
            color: #f39c12;
        }
        #deeplink-button {
            background-color: #FFCD00; /* PayPay yellow */
            color: #333;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #deeplink-button:hover {
            background-color: #E6B800; /* Darker yellow on hover */
        }
        #qr-code-container img {
            max-width: 200px;
            height: auto;
            margin: 20px auto;
            border: 1px solid #ddd;
        }
        #qr-code-container p {
            word-break: break-all;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="store-name">モバおる - {{ store_name }}</div>
        <div class="user-info">
            <span>{{ u_name }}</span> {# username を u_name に修正 #}
        </div>
    </header>

    <div class="sub-header">
        <p>注文最終確認</p>
        <a href="{{ url_for('users_order.back_to_home_and_clear_cart') }}">ホームに戻る</a>
    </div>

    <main class="container">
        <div class="store-info">
            <span class="name">{{ store_name }}</span>
        </div>

        <div class="order-summary">
            <div class="cart-list">
                {% for item in cart %}
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <span>{{ item.name }}</span>
                            <span>{{ item.quantity }} 個</span>
                        </div>
                        <span>{{ item.price * item.quantity }}円</span>
                    </div>
                {% endfor %}
            </div>
            <div class="cart-total">
                合計: <span id="display-total-price">{{ total_price }}</span>円
            </div>
        </div>

        <div class="payment-actions">
            <h3>お支払い方法</h3>
            {# このフォームは削除またはコメントアウトし、JavaScriptで処理するボタンに置き換える #}
            {# <form action="{{ url_for('users_order.create_order') }}" method="POST">
                <input type="hidden" name="amount" value="{{ total_price }}">
                <button type="submit" class="btn btn-paypay">PayPayで支払う</button>
            </form> #}
            
        </div>

        {# このフォームの submit をJavaScriptでPayPay決済トリガーに変更する #}
        {# 従来の「注文を確定する」ボタンもPayPay決済をトリガーするように変更 #}
        <form id="confirm-order-form" action="#" method="POST"> {# actionを#に変更し、JSで制御 #}
            <p>上記の内容でよろしければ、PayPayで支払いを確定してください。</p>
            <button type="submit" class="btn btn-primary" id="start-paypay-button">PayPayで支払う</button>
        </form>

        <br>
        {# カートに戻るボタンはそのまま #}
        <a href="{{ url_for('users_order.cart_confirmation') }}" class="btn btn-secondary">カートに戻る</a>
    </main>

    <div class="under-hedder">
        <a href="{{ url_for('users_order.cart_confirmation') }}">戻る</a>
        <a href="{{ url_for('users_order.reservation_number') }}" style="text-decoration:none; color: inherit;">リンク表示</a>
    </div>

    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>PayPay支払い</h2>
            <button id="deeplink-button" class="checkout-button" style="display: none; margin-bottom: 20px;">PayPayアプリで開く</button>
            <div id="qr-code-container">
            </div>
            <p id="payment-status-message"></p>
            <p id="qr-instruction" style="margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <script>
        // API_BASE_URL はブループリントのURLプレフィックスを含めない
        // Flaskが提供するurl_forを使って絶対パスを生成するのが最も確実
        const API_BASE_URL = '{{ url_for("users_order.paypay_create_qr").split("/paypay/create-qr")[0] }}';

        // HTML要素の取得
        const startPaypayButton = document.getElementById('start-paypay-button');
        const confirmOrderForm = document.getElementById('confirm-order-form');
        const qrModal = document.getElementById('qr-modal');
        const closeModalButton = document.querySelector('.close-button');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const paymentStatusMessage = document.getElementById('payment-status-message');
        const deeplinkButton = document.getElementById('deeplink-button');
        const qrInstruction = document.getElementById('qr-instruction');

        // カート情報と合計金額をJinja2から直接取得
        const cartData = {{ cart | tojson }};
        const totalAmount = {{ total_price }};

        let currentMerchantPaymentId = null;
        let pollInterval = null;
        let lastQrCodeUrl = '';

        // ページ読み込み時に、PayPayからのリダイレクトがあったか確認し、ポーリングを再開
        window.addEventListener('load', () => {
            const storedMerchantId = "{{ session.pop('paypay_callback_merchant_id', '') }}";
            if (storedMerchantId) {
                currentMerchantPaymentId = storedMerchantId;
                qrModal.style.display = 'flex';
                paymentStatusMessage.textContent = "PayPayアプリからのリダイレクトを確認中...";
                pollPaymentStatus(currentMerchantPaymentId);
            }
            // Flaskからのflashメッセージを表示（あれば）
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    alert("{{ messages[0] }}");
                {% endif %}
            {% endwith %}
        });

        // 「PayPayで支払う」ボタンのクリックイベント
        startPaypayButton.addEventListener('click', async (event) => {
            event.preventDefault();

            if (cartData.length === 0 || totalAmount === 0) {
                alert('カートに商品がないか、合計金額が0円です。');
                return;
            }

            paymentStatusMessage.textContent = "PayPay支払い情報を準備中...";
            paymentStatusMessage.className = '';
            qrCodeContainer.innerHTML = '';
            deeplinkButton.style.display = 'none';
            qrInstruction.style.display = 'none';
            qrModal.style.display = 'flex';

            const orderItems = cartData.map(item => ({
                name: item.name,
                quantity: item.quantity,
                unitPrice: {
                    amount: item.price,
                    currency: 'JPY'
                }
            }));
            
            try {
                const response = await fetch(`${API_BASE_URL}/paypay/create-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderItems: orderItems,
                        amount: {
                            amount: totalAmount,
                            currency: 'JPY'
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`QRコード生成エラー: ${errorData.details || response.statusText}`);
                }

                const data = await response.json();
                console.log("QR Creation Response:", data);

                if (data.resultInfo && data.resultInfo.code === 'SUCCESS' && data.data) {
                    currentMerchantPaymentId = data.data.merchantPaymentId;
                    lastQrCodeUrl = data.data.url;

                    let qrCodeHtml = '';

                    if (data.data.deeplink) {
                        deeplinkButton.dataset.deeplink = data.data.deeplink;
                        deeplinkButton.style.display = 'block';

                        qrCodeHtml = `
                            <a href="${data.data.deeplink}" target="_blank" rel="noopener noreferrer" style="display: inline-block; cursor: pointer;">
                                <img src="${data.data.url}" alt="PayPay QR Code">
                            </a>
                            <p>または直接リンク: <a href="${data.data.url}" target="_blank" rel="noopener noreferrer">${data.data.url}</a></p>
                        `;
                        qrInstruction.textContent = "スマホでPayPayアプリから開くか、QRコードをスキャンして支払いを完了してください。";
                        qrInstruction.style.display = 'block';
                        paymentStatusMessage.textContent = "PayPayアプリで支払い中...";

                    } else if (data.data.url) {
                        qrCodeHtml = `
                            <img src="${data.data.url}" alt="PayPay QR Code">
                            <p>または直接リンク: <a href="${data.data.url}" target="_blank" rel="noopener noreferrer">${data.data.url}</a></p>
                        `;
                        qrInstruction.textContent = "QRコードをスキャンして支払いを完了してください。";
                        qrInstruction.style.display = 'block';
                        paymentStatusMessage.textContent = "QRコードをスキャンして支払い中...";
                    } else {
                         paymentStatusMessage.textContent = "支払い情報の取得に失敗しました。";
                         console.error("No valid QR or Deeplink URL found:", data);
                         return;
                    }

                    qrCodeContainer.innerHTML = qrCodeHtml;

                    if (data.data.deeplink) {
                        const qrLink = qrCodeContainer.querySelector('a:first-child');
                        if (qrLink) {
                            qrLink.addEventListener('click', (e) => {
                                e.preventDefault();
                                window.location.href = deeplinkButton.dataset.deeplink;
                                paymentStatusMessage.textContent = "PayPayアプリに移動しました。アプリで支払いを完了してください。";
                            });
                        }
                    }

                    pollPaymentStatus(currentMerchantPaymentId);

                } else {
                    paymentStatusMessage.textContent = "QRコードの生成に失敗しました。";
                    console.error("Failed to get QR code or Deeplink URL:", data);
                }

            } catch (error) {
                console.error("Checkout error:", error);
                paymentStatusMessage.textContent = `エラー: ${error.message}`;
            }
        });

        // ディープリンクボタンのクリックイベント
        deeplinkButton.addEventListener('click', () => {
            const deeplinkUrl = deeplinkButton.dataset.deeplink;
            if (deeplinkUrl) {
                window.location.href = deeplinkUrl;
                paymentStatusMessage.textContent = "PayPayアプリに移動しました。アプリで支払いを完了してください。";
            }
        });

        // 支払いステータスをポーリングする関数
        async function pollPaymentStatus(merchantPaymentId) {
            paymentStatusMessage.textContent = "支払いステータスを確認中...";
            paymentStatusMessage.className = '';

            const pollStep = 5000;
            const maxPollingTime = 240000;
            const maxAttempts = maxPollingTime / pollStep; 
            let attempts = 0;

            if (pollInterval) {
                clearInterval(pollInterval);
            }

            pollInterval = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(pollInterval);
                    paymentStatusMessage.textContent = "タイムアウト: 支払いステータスを確認できませんでした。";
                    paymentStatusMessage.classList.add('status-timeout');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/paypay/order-status/${merchantPaymentId}`);
                    if (response.status === 429) {
                        paymentStatusMessage.textContent = "PayPay APIのレート制限中。しばらくお待ちください...";
                        console.warn("PayPay API RATE_LIMIT encountered.");
                        return;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${errorData.message || response.statusText}`);
                    }
                    const data = await response.json();
                    console.log("Polling Status Response:", data);

                    if (data.data && data.data.status) {
                        const status = data.data.status;
                        if (status === 'COMPLETED') {
                            clearInterval(pollInterval);
                            paymentStatusMessage.textContent = "支払い完了！ありがとうございます！";
                            paymentStatusMessage.classList.add('status-completed');
                            window.location.href = "{{ url_for('users_order.reservation_number') }}";

                        } else if (status === 'CANCELED' || status === 'FAILED') {
                            clearInterval(pollInterval);
                            paymentStatusMessage.textContent = "支払い失敗。もう一度お試しください。";
                            paymentStatusMessage.classList.add('status-failed');
                            qrInstruction.style.display = 'none';
                            deeplinkButton.style.display = 'none';
                        } else {
                            paymentStatusMessage.textContent = `支払いステータス: ${status}...`;
                        }
                    } else if (data.error) {
                        clearInterval(pollInterval);
                        paymentStatusMessage.textContent = `エラー: ${data.message || data.error}`;
                        paymentStatusMessage.classList.add('status-failed');
                        qrInstruction.style.display = 'none';
                        deeplinkButton.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Polling error:", error);
                    clearInterval(pollInterval);
                    paymentStatusMessage.textContent = `ポーリング中にエラーが発生しました: ${error.message}`;
                    paymentStatusMessage.classList.add('status-failed');
                    qrInstruction.style.display = 'none';
                    deeplinkButton.style.display = 'none';
                }
            }, pollStep);
        }

        // モーダルを閉じるイベント
        closeModalButton.addEventListener('click', () => {
            qrModal.style.display = 'none';
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        });

        // モーダル外をクリックして閉じる
        window.addEventListener('click', (event) => {
            if (event.target === qrModal) {
                qrModal.style.display = 'none';
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }
        });
    </script>
</body>
</html>